# MT5 Trade Copier Ecosystem

A comprehensive and powerful trade copying solution designed for MetaTrader 5. This system allows you to copy trades from multiple master accounts to multiple slave accounts with advanced configuration options, risk management, and full control through a Telegram bot.

## Overview

This project is more than just a simple trade copier. It's an entire ecosystem built to provide a reliable and flexible way to manage trade replication across different MT5 accounts. The system is composed of three main components:

1.  **MetaTrader 5 Expert Advisor (EA):** The core component that runs on the MT5 terminal. It can operate in either **Master** or **Slave** mode.
2.  **Telegram Management Bot:** A Python-based Telegram bot that acts as a remote control for the entire ecosystem. It allows you to configure masters, slaves, connections, and risk settings on the fly.
3.  **Telegram Log Watcher:** A Python script that actively monitors the log files generated by the slave EAs and sends real-time, formatted notifications for important events (trades opened/closed, errors, drawdown alerts) to your Telegram.

## Features

-   **Multi-Master & Multi-Slave:** Copy trades from several master accounts to numerous slave accounts.
-   **Flexible Mapping:** Easily connect any slave to any combination of masters.
-   **Advanced Volume Control:**
    -   **Multiplier:** Copy trades with a volume multiplied by a specific factor.
    -   **Fixed Volume:** Open all copied trades with a predefined fixed lot size.
-   **Robust Risk Management:**
    -   **Daily Drawdown Stop:** Automatically close all positions and stop copying for the day if a specified equity drawdown percentage is reached.
    -   **Drawdown Alert:** Receive a Telegram notification when the drawdown reaches a warning level.
    -   **Trailing Drawdown:** (Optional) The drawdown is calculated from the peak equity of the day, not the starting balance.
-   **Remote Management via Telegram:**
    -   View the status of the entire system.
    -   Enable or disable connections between masters and slaves.
    -   Adjust slave settings (DD percentage, alert level, copy mode).
    -   Change master volume settings (Multiplier/Fixed).
    -   Remotely trigger a reset for the daily drawdown lock.
    -   Regenerate all configuration files with one command.
-   **Real-time Telegram Notifications:** Get instant alerts for trade openings, closings, drawdown warnings, and EA errors.
-   **Symbol Mapping:** Automatically handles different symbol names between brokers (e.g., `XAUUSD` to `GOLD`).
-   **Selective Copying:** Configure slaves to copy all symbols or only trades on specific symbols like GOLD.
-   **Atomic File Operations:** Configuration files are written in a way that prevents corruption, even if the system is interrupted.

## How It Works

1.  **Master EA:** The EA running in `MASTER` mode on an account writes all its open positions' data (ticket, symbol, volume, SL/TP) into a dedicated text file.
2.  **Slave EA:** The EA in `SLAVE` mode reads the text files from its designated masters.
3.  **Trade Execution:** If it finds a new trade, it copies it to the slave account, applying the configured volume and risk settings. It also monitors for closed trades and closes the corresponding slave positions.
4.  **Logging:** The Slave EA writes detailed logs of its actions (trades opened/closed, errors, DD events) into a daily log file.
5.  **Telegram Bot:** The user interacts with the Telegram bot to modify the central `ecosystem.json` configuration file. The bot then regenerates the individual `.cfg` and `.txt` files that the EAs read.
6.  **Log Watcher:** The `log_watcher.py` script continuously monitors the log files. When a new important line is detected, it parses it and sends a formatted message to the admin via Telegram.

## Setup & Configuration

### Prerequisites

-   MetaTrader 5 Terminal.
-   Python 3.7+.
-   A Telegram Bot Token from BotFather.
-   Your Telegram User ID.

### 1. MetaTrader 5 EA (`TradeCopier.mq5`)

-   Compile `TradeCopier.mq5` in your MetaEditor.
-   **For Master Accounts:**
    -   Attach the compiled EA to a chart.
    -   Set `Mode` to `MODE_MASTER`.
    -   If you have multiple masters, set `MasterSuffix` to `SUFFIX_M1`, `SUFFIX_M2`, etc., for each one. This creates unique data files (e.g., `TradeCopier_M1.txt`).
-   **For Slave Accounts:**
    -   Attach the compiled EA to a chart.
    -   Set `Mode` to `MODE_SLAVE`.
    -   Set a unique `SlaveID` (e.g., `slave_A`). This ID must match the one in `ecosystem.json`.
    -   Set your desired `MagicNumber`.

### 2. Python Scripts (Bot & Watcher)

1.  Clone the repository.
2.  Install the required Python libraries:
    ```bash
    pip install python-telegram-bot python-dotenv
    ```
3.  Create a `.env` file in the same directory as the Python scripts and add the following information:

    ```ini
    # Your Telegram bot token from BotFather
    BOT_TOKEN="123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11"

    # Your numeric Telegram User ID
    ADMIN_ID="1717599240"

    # List of user IDs allowed to use the bot (comma-separated)
    ALLOWED_USERS="1717599240,987654321"

    # --- Paths ---
    # Absolute or relative path to the ecosystem.json file
    ECOSYSTEM_PATH="files/ecosystem.json"

    # Path to the MT5 /MQL5/Files/ directory where logs are stored
    LOG_DIRECTORY_PATH="C:/Users/YourUser/AppData/Roaming/MetaQuotes/Terminal/YOUR_MT5_INSTANCE_ID/MQL5/Files/"
    ```

### 3. `ecosystem.json`

This file is the brain of the operation. It defines all masters, slaves, and their relationships. Place it in the path you specified in `ECOSYSTEM_PATH`.

-   `masters`: An array of master account objects.
    -   `id`: A unique ID for the master.
    -   `name`: A user-friendly name.
    -   `file_path`: The data file the Master EA writes to (e.g., `TradeCopier_M1.txt`).
    -   `config_file`: The configuration file for this master's volume settings.
-   `slaves`: An array of slave account objects.
    -   `id`: A unique ID that **must match the `SlaveID` input in the EA**.
    -   `name`: A user-friendly name.
    -   `settings`: Key-value pairs for slave-specific settings.
-   `mapping`: An object where each key is a `slave_id` and the value is an array of `master_id`s it should copy from.

See the provided `ecosystem.json` for a clear example.

## Usage

1.  Run the Telegram bot:
    ```bash
    python config_bot.py
    ```
2.  Run the log watcher:
    ```bash
    python log_watcher.py
    ```
3.  Start a chat with your bot on Telegram and use the `/start` command to access the main menu. From there, you can manage the entire system through the inline keyboard buttons.

## License

This project is licensed under the MIT License. See the `LICENSE` file for details.